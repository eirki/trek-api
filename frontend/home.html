<html>
  <head>
    <title>Trek</title>
  </head>

  <body>
    <h1>Hvor vil du dra?</h1>
    <p>
      <button type="button" onclick="logout()">Log out</button>
    </p>
    <p>
      <button type="button" onclick="addTracker('fitbit')">
        Authorizate Fitbit
      </button>
    </p>
    <p>
      <button type="button" onclick="addTracker('withings')">
        Authorizate Withings
      </button>
    </p>
    <div id="me"></div>
  </body>

  <script>
    "use strict";
    function redirect() {
      location.href = "/login";
    }
    function logout() {
      localStorage.removeItem("trekToken");
      redirect();
    }

    async function addTracker(tracker_name) {
      let url = new URL("/user/add_tracker/" + tracker_name, location.href);
      const token = localStorage.getItem("trekToken");
      url.searchParams.set("redirect_url", location.origin);
      console.log(`Fetching ${url}`);
      await fetch(url, {
        method: "GET",
        headers: {
          Authorization: "Bearer " + token,
        },
      })
        .then((response) => response.json())
        .then((data) => (location.href = data.auth_url));
    }

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    let token = urlParams.get("jwt");
    if (token) {
      console.log("storing token");
      window.localStorage.setItem("trekToken", token);
      console.log("cleaning url");
      window.history.replaceState(null, document.title, location.origin);
    } else {
      console.log("trying to fetch token");
      token = localStorage.getItem("trekToken");
      if (!token) {
        console.log("no token, redirecting to login");
        redirect();
      } else {
        let url = new URL("/user/me/", location.href);
        console.log(`Fetching ${url}`);
        fetch(url, {
          method: "GET",
          headers: {
            Authorization: "Bearer " + token,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            let element = document.getElementById("me");
            element.innerHTML = JSON.stringify(data);
          });
      }
    }
  </script>
</html>
